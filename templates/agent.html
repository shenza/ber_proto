<!DOCTYPE html>
<html>
<head>
    <title>Customer Care - Voice Agent Screen</title>
    <link rel="stylesheet" href="//media.twiliocdn.com/taskrouter/quickstart/agent.css"/>
    <script src="https://code.jquery.com/jquery-3.4.1.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>

    <script src="//media.twiliocdn.com/taskrouter/js/v1.14/taskrouter.min.js"></script>
    <script type="text/javascript">
        const activity_Offline	= "WA6cff497e588b68cb826376b6810db370"
        const activity_Available	= "WA9e70a07fcfabfe70380182829d808b33"
        const activity_Unavailable	= "WAf8bb3dfe71aa328e884f4a5e092431ec"
        const activity_Busy	= "WAb399dab8c30f9bdc5f42e3a10d34af83"
        zoom = "";
        newrow = "";
        agora = "";
        aboutme = "";
        var currentReservedTask;
        var incaseLost;

        /* Subscribe to a subset of the available TaskRouter.js events for a worker */
        function registerTaskRouterCallbacks() {
            worker.on('ready', function(worker) {
                console.log('are we always on ')
                console.log(worker)
                agentActivityChanged(worker.activityName);
                logger("Successfully registered as: " + worker.friendlyName)
                logger("Current activity is: " + worker.activityName);
                console.log(worker.taskSid)
                //not sure if this is need here, but this runs for almost everything
                //complete_task(worker, currentReservedTask);

                if (worker.attributes.ZOOM){
                    zoom = worker.attributes.ZOOM;
                    videoclick("zoom", zoom);
                }
                if (worker.attributes.Newrow){
                    newrow = worker.attributes.Newrow;
                    videoclick("newrow", newrow);
                }
                if (worker.attributes.Agora){
                    agora = worker.attributes.Agora;
                    videoclick("agora", agora);
                }
                if (worker.attributes.about){
                    about = worker.attributes.about
                }
                console.log('dddddddddddddd');
                console.log(zoom)
                /*
                try{
                    //console.log(worker.attributes.ZOOM)
                    zoom = worker.attributes.ZOOM
                }catch (error) {
                    console.log('no zoom attribute');
                }
                console.log(zoom)
                 
                try{
                    console.log(worker.attributes.Newrow)
                    newrow = worker.attributes.Newrow
                }catch (error) {
                    console.log('no newrow attribute');
                }

                try{
                    console.log(worker.attributes.Agora)
                    agora = worker.attributes.Agora
                }catch (error) {
                    console.log('no agora attribute');
                }

                try{
                    console.log(worker.attributes.about)
                    about = worker.attributes.Agora 
                }catch (error) {
                    console.log('no about attribute');
                }
                */
                console.log(worker.sid)             // 'WKxxx'
      // 'Worker 1'
      // 'Reserved'

    


            });

            worker.on('activity.update', function(worker) {
                agentActivityChanged(worker.activityName);
                logger("Worker activity changed to: " + worker.activityName);
            });

            worker.on("reservation.created", function(reservation) {
                logger("-----");
                console.log(reservation);
                //task has been create, so track sid for completion
                currentReservedTask = reservation.taskSid;
                incaseLost =  reservation.taskSid;
                logger("You have been reserved to handle a call!");
                logger("Call from: " + reservation.task.attributes.name);
                logger("Selected language: " + reservation.task.attributes.language);
                logger("level: " + reservation.task.attributes.level);
                logger("-----");
                var elements = document.getElementsByClassName(('agent-activity ' + 'Busy'));
                console.log(elements);
                elements.item(0).style.display = 'block';
                document.getElementById("student_level").innerHTML = reservation.task.attributes.level ;
                document.getElementById("student_language").innerHTML = reservation.task.attributes.language ;
                document.getElementById("student_name").innerHTML = reservation.task.attributes.name ;
                acceptReservation(reservation);
                /*
                //this stuff works
                var params = {"Priority":"15"};
                logger(reservation.taskSid);
worker.updateTask(reservation.taskSid, params,
    function(error, updatedTask) {
        if(error) {
            console.log(error.code);
            console.log(error.message);
            return;
        }
        console.log("Updated Task Priority: "+updatedTask.priority);
    }
);
        */

            });

            worker.on("reservation.accepted", function(reservation) {
                console.log('do we find you here?')

                //switch instructer work to status busy
                logger("Reservation " + reservation.sid + " accepted!");
                agentActivityChanged('Busy');
                worker.update({"ActivitySid":activity_Busy});
                
            });

            worker.on("reservation.rejected", function(reservation) {
                logger("Reservation " + reservation.sid + " rejected!");
            });

            worker.on("reservation.timeout", function(reservation) {
                logger("Reservation " + reservation.sid + " timed out!");
            });

            worker.on("reservation.canceled", function(reservation) {
                logger("Reservation " + reservation.sid + " canceled!");
            });
            /*
            worker.completeTask(taskSid, function(error, completedTask) {
                if(error) {
                    console.log(error.code);
                    console.log(error.message);
                    return;
                }
                console.log("Completed Task: "+completedTask.assignmentStatus);
            });
            */
        }

        /* Hook up the agent Activity buttons to TaskRouter.js */

        function bindAgentActivityButtons() {
            // Fetch the full list of available Activities from TaskRouter. Store each
            // ActivitySid against the matching Friendly Name
            var activitySids = {};
            worker.activities.fetch(function(error, activityList) {
                var activities = activityList.data;
                console.log(activities)
                logger(activityList)
                var i = activities.length;
                while (i--) {
                    activitySids[activities[i].friendlyName] = activities[i].sid;
                    logger(activitySids[activities[i].friendlyName]);
                    logger(activities[i].sid);
                }
            });

            /* For each button of class 'change-activity' in our Agent UI, look up the
             ActivitySid corresponding to the Friendly Name in the buttonâ€™s next-activity
             data attribute. Use Worker.js to transition the agent to that ActivitySid
             when the button is clicked.*/
            var elements = document.getElementsByClassName('change-activity');
            var i = elements.length;
            console.log('-----------------------------');
            logger(activitySids)
            console.log()
            console.log('-----------------------------');
            logger(activitySids)
            while (i--) {
                elements[i].onclick = function() {
                    logger(i);
                    logger(this.dataset.nextActivity)
                    var nextActivity = this.dataset.nextActivity;
                    
                    var nextActivitySid = activitySids[nextActivity];
                    logger('next activity' + nextActivitySid)
                    worker.update({"ActivitySid":nextActivitySid});
                }
            }
        }

        function videoclick(classId, videolink){
            console.log("try to set video buttons");
            //turn button on
            video_button = document.getElementById(classId);
            console.log(video_button)
            video_button.style.display = "inline-block";
            video_button.onclick = function(){
                console.log('button has been clicked, time to open video link to:');
                console.log(videolink);
                window.open(videolink)
                
            }            
        }

        function resetvideoclick(){

        }

        function complete_task(worker, currentReservedTask){
            logger("time to complete" + currentReservedTask)
            console.log(worker)
            logger(worker.reservation)
            console.log('ddddd')
            console.log('goin to complete this task: ' + currentReservedTask)
            //df = document.getElementsByClassName("complete-task");
            //console.log(df.length)
            document.getElementById('dafuq').onclick = function(){
                console.log('task has been completed')
                
                
                //WTd26e95d182f05eaa0f9ad7b5386c9647
                if (currentReservedTask){
                    taskSid = currentReservedTask;
                }else{
                    taskSid = incaseLost;
                }
                
                //taskSid = "WTd26e95d182f05eaa0f9ad7b5386c9647";
                //worker.reservation.completeTask(taskSid, function(error, completedTask) {
                console.log(taskSid)
                //console.log(incaseLost)
                //return
                //cant run this without taskid
                if(taskSid){
                    worker.completeTask(taskSid, function(error, completedTask) {
                            if(error) {
                                console.log(error.code);
                                console.log(error.message);
                                return;
                            }
                            console.log("Completed Task: "+completedTask.assignmentStatus);
                            agentActivityChanged('wrapup');
                        }
                    );
                }
            }
           
        }

        function acceptReservation(reservation){
            console.log(reservation)
            logger("time to accept")
            console.log(worker)
            logger(worker.reservation)
            
            //df = document.getElementsByClassName("complete-task");
            //console.log(df.length)
            document.getElementById('accept_res').onclick = function(){
                console.log('accept reservation')
                console.log(worker.reservation)

            console.log('before post');
            console.log(reservation);
            //just incase its not been set
            currentReservedTask = reservation.taskSid;
            data = {"taskSid":reservation.taskSid, "reservationSid":reservation.sid}
            console.log(data);
                $.ajax({
                    url: '/accept_reservation',
                    data: JSON.stringify(data),
                    contentType: 'application/json;charset=UTF-8',
                    type: 'POST',
                    dataType: "json",
                    success: function(response) {
                        console.log(response);
                        worker.update({"ActivitySid":activity_Busy});
                        //disable the start button
                        start_lesson_button = document.getElementById('accept_res');
                        console.log('should be hiding the start lesson button now')
                        start_lesson_button.style.display = "none";

                        //display video sections 
                        start_lesson_button = document.getElementById('videosection');
                        console.log('should be hiding the start lesson button now')
                        start_lesson_button.style.display = "block";                       
                    },
                    error: function(error) {
                        console.log(error);
                        console.log('could not start lesson')
                    }
                });

            }


            }

            
            
        


        /* Update the UI to reflect a change in Activity */

        function agentActivityChanged(activity) {
            logger('activity changed')
            logger(activity)
            hideAgentActivities();
            showAgentActivity(activity);
        }

        function hideAgentActivities() {
            var elements = document.getElementsByClassName('agent-activity');
            var i = elements.length;
            while (i--) {
                elements[i].style.display = 'none';
            }
        }

        function showAgentActivity(activity) {
            //activity = activity.toLowerCase();
            console.log(activity)
            var elements = document.getElementsByClassName(('agent-activity ' + activity));
            console.log(elements);
            elements.item(0).style.display = 'block';
        }

        /* Other stuff */

        function logger(message) {
            var log = document.getElementById('log');
            log.value += "\n> " + message;
            log.scrollTop = log.scrollHeight;
        }

        
        
        window.onload = function() {
            // Initialize TaskRouter.js on page load using window.workerToken -
            // a Twilio Capability token that was set from rendering the template with agents endpoint
            logger("Initializing...");
            window.worker = new Twilio.TaskRouter.Worker("{{ worker_token }}");
            //window.workspace = new Twilio.TaskRouter.Workspace("{{ worker_token }}");


            registerTaskRouterCallbacks();
            bindAgentActivityButtons();
            //acceptReservation();
            //complete_task();
            //try to get the task that the current worker has - this is done incase of page refresh
            //or some issues to force cancel/complete previous task
            current_worker_sid = "{{current_worker_sid}}";
            console.log(window.worker);
            console.log(current_worker_sid)
            console.log('above');
            var queryParams = {"ReservationStatus":"accepted", "WorkerSid":current_worker_sid};
            worker.fetchReservations(
                function(error, reservations) {
                    if(error) {
                        console.log(error.code);
                        console.log(error.message);
                        return;
                    }
                    console.log(reservations)
                    var data = reservations.data;
                    for(i=0; i<data.length; i++) {
                        console.log(data[i].sid);
                        
                    }
                    console.log('ggggggggggggggggggggggg')
                    console.log(data)
                    try{
                        currentReservedTask = reservations.data[0].taskSid
                        currentTaskAttr = reservations.data[0].task.attributes
                        document.getElementById("student_level").innerHTML = currentTaskAttr.level ;
                        document.getElementById("student_language").innerHTML = currentTaskAttr.language ;
                        document.getElementById("student_name").innerHTML = currentTaskAttr.name ;
                    }catch (error) {
                        console.log('no existing tasks')
                    }
                    
                    console.log(currentReservedTask)
                    worker.com
                    complete_task(worker, currentReservedTask);
                },
                queryParams
            );

            


        };
    </script>
    <style type="text/css" media="screen">
        .video, .start-zoom, .start-newrow, .start-agora {display:none;}
        
        
        /* Add style rules here */
        
    </style>
</head>
<body>
<div class="content">
    <section class="agent-activity Available"  style="line-height: 1 !important;">
        <p class="activity">Current Online, </br> waiting for students</p>
        <button class="change-activity" data-next-activity="Offline">Go Offline</button>
    </section>
    <section class="agent-activity Offline">
        <p class="activity"><span>Currently Offline</span></p>
        <button class="change-activity" data-next-activity="Available">Go Online</button>
    </section>
    <section class="agent-activity Busy"  style="line-height: 1 !important;">
        <p class="activity"><span>Lesson Connected</span></p>
        <p>lesson: <span id="student_level"></span> - <span id="student_language"></span></p>
        <p>Student Name: <span id="student_name"></span></p>
        <!--<button class="change-activity" data-next-activity="Busy">Start Lesson</button>-->
        <button id="accept_res" class="accept-reservation" data-next-activity="Busy">Start Lesson</button>
        <button id="dafuq" class="complete-task" data-next-activity="Available">Lesson Completed</button>
        <section class="video" id="videosection">
            <p>Choose a video provider</p>
            <button id="zoom" class="start-zoom" data-next-activity="Busy">Start Zoom</button>
            <button id="newrow" class="start-newrow" data-next-activity="Busy">Start Newrow</button>
            <button id="agora" class="start-agora" data-next-activity="Available">Start Agora</button>
        </section>
    </section>
    
    <section class="agent-activity reserved">
        <p class="activity">Reserved</p>
    </section>
    <section class="agent-activity busy">
        <p class="activity">Busy</p>
    </section>
    <section class="agent-activity wrapup">
        <p class="activity">Wrap-Up</p>
        <button class="change-activity" data-next-activity="Available">Go Online</button>
        <button class="change-activity" data-next-activity="Offline">Go Offline</button>
    </section>
    <section class="log">
      <textarea id="log" readonly="true"></textarea>
    </section>
</div>
</body>
</html>